---
layout: post
title: Connect i2c mpu-9250 to jetson nano
categories: nvidia
tags: [nano, sensors, imu]
image: jetson-nano.png
public: true
description: Connect mpu-9250 i2c device to jetson, read IMU data using python library
---
# mpu-9250
### Accelerometer
Measure acceleration, which is the **rate of change** of the velocity of an object ($\frac{m}{s^{2}}$) or in G-force (1g=9.8$\frac{m}{s^{2}}$ on earth)
Accelerometers are often used to calculate a tilt angle. They can only do this reliably when they are static and not moving.
### Gyroscope
### Magnetometer
&nbsp;  
&nbsp;  
&nbsp;  
# I2C
serial communication protocol 
I²C is designed to be a **multi-slave**, **half-duplex** bus meaning a master device can communicate with multiple slave devices connected to the same bus, but communication can only occur in one direction at a time

![](/images/2020-12-24-14-53-42.png)

- SDA: Serial Data packet send by master or slave.
- SCL: Serial Clock signal generated by the master and is used to synchronies the data packets on the SDA wire between the master and slaves
  
Each slave device on the I²C bus must have a unique address, usually 7bit address (0x03 to 0x77.)

&nbsp;  
&nbsp;  
&nbsp;  
# install

```
sudo apt install i2c-tools
```

# wiring

![](/images/2020-12-23-23-57-52.png)

| MPU9250    | Nano |
| ---------- | ---- |
| SDA        | 3    |
| SCL        | 5    |
| VCC (3.3v) | 1    |
| Gnd        | 39   |

> Note: is i2c bus number 1

&nbsp;  
&nbsp;  
&nbsp;

# i2c-tools

i2c-tools is a package contains a set of I2C tools

## i2cdetect

i2cdetect is an program to scan an I2C bus for devices.

```bash
i2cdetect -r -y 1

# -y disabled interactive mode
# -r "receive byte" command for probing.
# 1 channel number

# Result
0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- 68 -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
```

## i2cset i2cget

Set and Read register from bus

```bash
# -y interactive
# 1 bus
# 0x68 device address (for i2cdetect)
# 0x40 register
# w read word (without read byte)
i2cget -y 1 0x68 0x40 w
```

&nbsp;  
&nbsp;  
&nbsp;

# python

- using `smbus` to read and write to hardware device

```
pip install smbus2
pip install mpu9250-jmdev
```

## implement scan

- using SMBus library

```python
from smbus2 import SMBus

def scan(bus_num=1, start=0x03, end=0x78):
    bus = SMBus(bus_num)
    for i in range(start, end):
        val = 1
        try:
            bus.read_byte(i)
        except OSError as e:
            val = e.args[0]
        finally:
            if val != 5:    # No device
                if val == 1:
                    print(hex(i))

if __name__ == "__main__":
    scan()
```

## Read Temp from mpu
![](/images/2020-12-24-15-21-07.png)

```python
import smbus2
bus = smbus2.SMBus(1)

ADDRESS = 0x68
TEMP_REGISTER = 0x41
DATA_LENGTH = 2

def dataConv(data1, data2):
    value = data1 | (data2 << 8)
    if(value & (1 << 16 - 1)):
        value -= (1<<16)
    return value

def readTemperature():
    data = bus.read_i2c_block_data(ADDRESS, TEMP_REGISTER, DATA_LENGTH)
    temp = dataConv(data[1], data[0])

    temp = round((temp / 333.87 + 21.0), 3)
    return temp

print(readTemperature())
```
# Reference

- [I2C Part 1 - Introducing I2C](https://www.abelectronics.co.uk/kb/article/1090/i2c-part-1---introducing-i2c)
- [MPU-9250-Sensors-Data-Collect](https://github.com/Intelligent-Vehicle-Perception/MPU-9250-Sensors-Data-Collect)
- [Gyroscopes and Accelerometers on a Chip](https://www.geekmomprojects.com/gyroscopes-and-accelerometers-on-a-chip/)

# Network settings

nano -(wire)> pc -(wifi)> internet

- pc used as router

## pc

```bash
# run as sudo
# route
echo 1 > /proc/sys/net/ipv4/ip_forward
# iptable
iptables -t nat -A POSTROUTING -o wlp3s0 -j MASQUERADE
```
